# @package _global_

# to execute this experiment run:
# python train.py experiment=example

defaults:
  - override /data: axov6
  - override /algorithm: qvae
  - override /callbacks: default
  - override /trainer: cpu
  - override /evaluator: default
  - override /evaluator_callbacks: default
  - override /logger: mlflow

tags: ["debug"]

experiment_name: debug
run_name: ${short_hash:${hydra:runtime.output_dir},12}

seed: 12345

trainer:
  profiler: "pytorch"
  gradient_clip_algorithm: norm
  gradient_clip_val: 1.0
  # overfit_batches: 1
  min_epochs: 1
  max_epochs: 1
  # max_steps: 1_000
  limit_train_batches: 10
  limit_val_batches: 10
  limit_test_batches: 10
  # check_val_every_n_epoch: 2

test: false

# callbacks:
#   log_data_mlflow: null
#   anomaly_rate:
#     metric_name: 'loss/kl_raw/full'
#     target_rates: [1]

#   # Checkpoints
#   min_loss_total_ckpt: null
#   stable_elbo_ckpt:
#     _target_: src.callbacks.model_checkpoint.SingleDatasetModelCheckpoint
#     dirpath: '${paths.checkpoints_dir}/${experiment_name}/${run_name}'
#     monitor: loss_kl_raw_q999
#     criterion:
#       _target_: src.callbacks.checkpointing.criterion.Stable
#       top_k: 1
#       threshold: 0.05
#       patience: 10
#     skip_ds:
#       - GluGluHTo2B_Par-MH-125
#       - GluGluHto2G_Par-MH-125
#       - GluGluHto2G_Par-MH-90
#       - GluGluHto2Tau_Par-MH-125
#       - GluGlutoHHto2B2WtoLNu2Q_Par-c2-0-kl-1-kt-1
#       - HHHto4B2Tau_Par-c3-0-d4-0
#       - HHHto6B_Par-c3-0-d4-0
#       - SUSYGluGluToBBHTo2B_Par-M-1200
#       - SUSYGluGluToBBHToBB_Par-M-120
#       - SUSYGluGluToBBHToBB_Par-M-350
#       - SUSYGluGluToBBHToBB_Par-M-600
#       - TTHTo2C_Par-MH-125
#       - TTHto2B_Par-MH-125
#       - VBFHTo2C_Par-MH-125
#       - VBFHto2B_Par-MH-125
#       - VBFHto2Tau_Par-MH-125
#       - WtoTauto3Mu
#       - ggH-suep-decay
#       - haa-4b-ma15
#       - SingleNeutrino_E-10-gun

#   max_rate_kl_raw_ckpt:
#     _target_: src.callbacks.model_checkpoint.SingleDatasetModelCheckpoint
#     dirpath: '${paths.checkpoints_dir}/${experiment_name}/${run_name}'
#     monitor: loss_kl_raw_full_rate1kHz
#     criterion:
#       _target_: src.callbacks.checkpointing.criterion.Max
#       top_k: 1
#     skip_ds:
#       - main_val
#       - SingleNeutrino_E-10-gun

# evaluator:
#   ckpts:
#     last: true
#     single:
#       loss_kl_raw_q999: ['stable']
#       loss_kl_raw_full_rate1kHz: ['max']

# evaluator_callbacks:
#   anomaly_efficiency:
#     metric_name: 'loss/kl_raw/full'
#     target_rates: [1]
#     log_raw_mlflow: false
#   loss:
#     _target_: src.evaluation.callbacks.loss.LossCallback
#     loss_name: 'loss/reco/sqrt_q95'
#     log_raw_mlflow: false
#   reco:
#     _target_: src.evaluation.callbacks.reco.ReconstructionPlots
#     nbatches: 2
#     output_name: reconstructed_data
#     datamodule: true # callback needs original datamodule
#     ckpt_dataset: last
#     datasets: ['main_test', 'SingleNeutrino_E-10-gun']
#     log_raw_mlflow: false
#   reco_ckpt_haa4b:
#     _target_: src.evaluation.callbacks.reco.ReconstructionPlots
#     nbatches: 2
#     output_name: reconstructed_data
#     datamodule: true # callback needs original datamodule
#     ckpt_dataset: haa-4b-ma15
#     datasets: ['main_test', 'SingleNeutrino_E-10-gun']
#     log_raw_mlflow: false
