# @package _global_

defaults:
  - override /data: basis
  - override /algorithm: vae
  - override /callbacks: ad_basics
  - override /trainer: cpu
  - override /evaluator: default
  - override /evaluator_callbacks: ad_basics
  - override /logger: mlflow

seed: 123
tags: ["vae", "quantised"]

experiment_name: qvae_training
run_name: ${short_hash:${hydra:runtime.output_dir},12}

algorithm:
  # Start from set of floating point weights.
  ckpt: "/data/deodagiu/adl1t/checkpoints/vicreg_vae_best/cd500829e9c6/single/loss_rmse_q95/stable/ds=main_val__metric=loss_rmse_q95__value=0.048008__epoch=13.ckpt"
  encoder:
    _target_: src.algorithms.components.encoder.hgq_variational_encoder
    in_dim: 57
    nodes: [9, 6]
    out_dim: 4

    input_layer_config:
      place: "datalane"
      q_type: "kif"
      i0: 5
      f0: 3
      trainable: false
      ic:
        _target_: hgq.constraints.Constant
        value: 5
      fc:
        _target_: hgq.constraints.Constant
        value: 3
      overflow_mode: 'SAT'

    output_layer_config:
      place: 'all'
      q_type: "kif"
      i0: 5
      f0: 3
      trainable: false
      ic:
        _target_: hgq.constraints.Constant
        value: 5
      fc:
        _target_: hgq.constraints.Constant
        value: 3
      overflow_mode: 'SAT'
    ebops: true

  decoder:
    _target_: src.algorithms.components.decoder.hgq_decoder
    in_dim: ${algorithm.encoder.out_dim}
    nodes: [6, 9]
    out_dim: ${algorithm.encoder.in_dim}

    output_layer_config:
      place: 'all'
      q_type: "kif"
      i0: 5
      f0: 3
      trainable: false
      ic:
        _target_: hgq.constraints.Constant
        value: 5
      fc:
        _target_: hgq.constraints.Constant
        value: 3
    ebops: true

trainer:
  gradient_clip_algorithm: norm
  gradient_clip_val: 1.0
  min_epochs: 1
  max_epochs: 20
  limit_val_batches: 10
  limit_test_batches: 10

test: true

callbacks:
  log_data_mlflow: null
  anomaly_rate:
    metric_name: 'loss/kl_raw/full'
    target_rates: [0.25]

  # Checkpoints
  min_loss_total_ckpt: null
  stable_mse_ckpt:
    _target_: src.callbacks.model_checkpoint.SingleDatasetModelCheckpoint
    dirpath: '${paths.checkpoints_dir}/${experiment_name}/${run_name}'
    monitor: loss_rmse_q95
    criterion:
      _target_: src.callbacks.checkpointing.criterion.Stable
      top_k: 1
      threshold: 0.05
      patience: 10
    ds:
      - main_val

  max_rate_mse_ckpt:
    _target_: src.callbacks.model_checkpoint.SingleDatasetModelCheckpoint
    dirpath: '${paths.checkpoints_dir}/${experiment_name}/${run_name}'
    monitor: loss_reco_full_rate0.25kHz
    criterion:
      _target_: src.callbacks.checkpointing.criterion.Max
      top_k: 1
    ds:
      - GluGluHTo2B_Par-MH-125
      - GluGluHto2G_Par-MH-125
      - GluGluHto2G_Par-MH-90
      - GluGluHto2Tau_Par-MH-125
      - GluGlutoHHto2B2WtoLNu2Q_Par-c2-0-kl-1-kt-1
      - HHHto4B2Tau_Par-c3-0-d4-0
      - HHHto6B_Par-c3-0-d4-0
      - SUSYGluGluToBBHTo2B_Par-M-1200
      - SUSYGluGluToBBHToBB_Par-M-120
      - SUSYGluGluToBBHToBB_Par-M-350
      - SUSYGluGluToBBHToBB_Par-M-600
      - TTHTo2C_Par-MH-125
      - TTHto2B_Par-MH-125
      - VBFHTo2C_Par-MH-125
      - VBFHto2B_Par-MH-125
      - VBFHto2Tau_Par-MH-125
      - WtoTauto3Mu
      - ggH-suep-decay
      - smj-case-A
      - haa-4b-ma15

evaluator:
  ckpts:
    last: true
    single:
      loss_rmse_q95: ['stable']
      loss_reco_full_rate0.25kHz: ['max']

evaluator_callbacks:
  anomaly_efficiency:
    metric_name: 'loss/kl_raw/full'
    target_rates: [0.25]
    log_raw_mlflow: false

  loss:
    _target_: src.evaluation.callbacks.loss.LossCallback
    loss_name: 'loss/kl_raw/sqrt_q95'
    log_raw_mlflow: false

  reco:
    _target_: src.evaluation.callbacks.reco.ReconstructionPlots
    nbatches: 2
    output_name: reconstructed_data
    datamodule: true # callback needs original datamodule
    ckpt_dataset: last
    datasets: ['main_test', 'SingleNeutrino_E-10-gun']
    log_raw_mlflow: false
