# @package _global_

# to execute this experiment run:
# python train.py experiment=example

defaults:
  - override /data: axov6
  - override /algorithm: vae
  - override /callbacks: basic
  - override /trainer: gpu
  - override /evaluator: default
  - override /evaluator_callbacks: basic
  - override /logger: mlflow

tags: ["vae", "2025_data"]

experiment_name: vae_alpha${algorithm.loss.scale}
run_name: bs${data.batch_size}_optim${algorithm.optimizer._target_}_lr${algorithm.optimizer.lr}_wd${algorithm.optimizer.weight_decay}

seed: 12345

# Make checkpoints at the minimum of the loss, only for the main data set and simulation.
# Make checkpoints at the maximum of the rate for the signal data sets, considering
# the kl divergence and the reco error as the anomaly score, respectively.
callbacks: 
  anomaly_rate:
    metric_names: ['loss/reco/full', 'loss/kl/full']

  min_loss_total_ckpt:
    skip_ds:
      - GluGluHTo2B_Par-MH-125
      - GluGluHto2G_Par-MH-125
      - GluGluHto2G_Par-MH-90
      - GluGluHto2Tau_Par-MH-125
      - GluGlutoHHto2B2WtoLNu2Q_Par-c2-0-kl-1-kt-1
      - HHHto4B2Tau_Par-c3-0-d4-0
      - HHHto6B_Par-c3-0-d4-0
      - SUSYGluGluToBBHTo2B_Par-M-1200
      - SUSYGluGluToBBHToBB_Par-M-120
      - SUSYGluGluToBBHToBB_Par-M-350
      - SUSYGluGluToBBHToBB_Par-M-600
      - TTHTo2C_Par-MH-125
      - TTHto2B_Par-MH-125
      - VBFHTo2C_Par-MH-125
      - VBFHto2B_Par-MH-125
      - VBFHto2Tau_Par-MH-125
      - WtoTauto3Mu
      - ggH-suep-decay
      - haa-4b-ma15

  max_rate_kl_ckpt:
    _target_: src.callbacks.model_checkpoint.SingleDatasetModelCheckpoint
    dirpath: '${paths.checkpoints_dir}/${experiment_name}/${run_name}'
    monitor: loss_kl_full_rate1
    criterion:
      _target_: src.callbacks.checkpointing.criterion.Max
      top_k: 1
    skip_ds:
      - main_val
      - SingleNeutrino_E-10-gun

  max_rate_reco_ckpt:
    _target_: src.callbacks.model_checkpoint.SingleDatasetModelCheckpoint
    dirpath: '${paths.checkpoints_dir}/${experiment_name}/${run_name}'
    monitor: loss_reco_full_rate1
    criterion:
      _target_: src.callbacks.checkpointing.criterion.Max
      top_k: 1
    skip_ds:
      - main_val
      - SingleNeutrino_E-10-gun

# Evaluate the checkponts that were mentioned before.
# Compute only the efficiency for each of the checkpoints.
evaluator:
  ckpts:
    last: true
    single:
      loss: ['min']
      loss_kl_full_rate1: ['max']
      loss_reco_full_rate1: ['max']

evaluator_callbacks:
  anomaly_efficiency:
    metric_names: ['loss/kl/full', 'loss/reco/full']
    target_rates: [1]
